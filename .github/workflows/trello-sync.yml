name: Trello Card Sync

on:
  push:
    branches:
      - main
      - develop
      - feature/**

jobs:
  update-trello:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Trello Card ID from commit message
        id: extract
        run: |
          echo "MESSAGE=$(git log -1 --pretty=%B)" >> $GITHUB_ENV
          CARD_ID=$(echo "$MESSAGE" | grep -oE 'TRELLO-[0-9]+' | head -1 || true)
          if [ -z "$CARD_ID" ]; then
            echo "No Trello card found."
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "found=true" >> $GITHUB_OUTPUT
            echo "card_id=$CARD_ID" >> $GITHUB_OUTPUT
          fi

      - name: Stop if no Trello card detected
        if: steps.extract.outputs.found == 'false'
        run: echo "Skipping – no Trello card in commit."

      - name: Find Trello Card by name
        if: steps.extract.outputs.found == 'true'
        id: findcard
        run: |
          CARD_ID="${{ steps.extract.outputs.card_id }}"
          RESPONSE=$(curl -s \
            "https://api.trello.com/1/search?query=$CARD_ID&modelTypes=cards&key=${{ secrets.TRELLO_KEY }}&token=${{ secrets.TRELLO_TOKEN }}")
          CARD_REAL_ID=$(echo $RESPONSE | jq -r '.cards[0].id')
          echo "actual_id=$CARD_REAL_ID" >> $GITHUB_OUTPUT

      - name: Add commit as comment to Trello card
        if: steps.extract.outputs.found == 'true'
        run: |
          COMMENT="New commit pushed:\n${{ env.MESSAGE }}\nCommit URL: ${{ github.event.head_commit.url }}"
          curl -X POST \
            "https://api.trello.com/1/cards/${{ steps.findcard.outputs.actual_id }}/actions/comments" \
            -d "text=$COMMENT" \
            -d "key=${{ secrets.TRELLO_KEY }}" \
            -d "token=${{ secrets.TRELLO_TOKEN }}"

      - name: Move card from Dev → Review
        if: steps.extract.outputs.found == 'true'
        run: |
          curl -X PUT \
            "https://api.trello.com/1/cards/${{ steps.findcard.outputs.actual_id }}" \
            -d "idList=${{ secrets.TRELLO_REVIEW_LIST_ID }}" \
            -d "key=${{ secrets.TRELLO_KEY }}" \
            -d "token=${{ secrets.TRELLO_TOKEN }}"
