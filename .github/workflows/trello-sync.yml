name: Trello Card Sync

on:
  push:
    branches:
      - main
      - develop
      - feature/**

jobs:
  update-trello:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse commits and extract Trello card IDs
        id: extract
        run: |
          echo "card_ids=" >> $GITHUB_OUTPUT
          echo "messages=" >> $GITHUB_OUTPUT

          # loop through each commit in this push
          for commit in $(jq -cr '.commits[]' <<< "${GITHUB_EVENT_PATH}" | sed 's/ /_/g'); do
            commit_msg=$(echo "$commit" | jq -r '.message')
            
            # extract trello:<id>
            if [[ "$commit_msg" =~ trello:([0-9]+) ]]; then
              card_id="${BASH_REMATCH[1]}"
              echo "Found card: $card_id"
              echo "card_ids+=${card_id} " >> $GITHUB_OUTPUT
              echo "messages+=${commit_msg//$'\n'/ };;" >> $GITHUB_OUTPUT
            fi
          done

      - name: Exit if no Trello reference found
        if: ${{ steps.extract.outputs.card_ids == '' }}
        run: echo "No Trello reference found in commits."

      - name: Process each Trello card
        if: ${{ steps.extract.outputs.card_ids != '' }}
        run: |
          IFS=' ' read -r -a cards <<< "${{ steps.extract.outputs.card_ids }}"
          IFS=';;' read -r -a msgs <<< "${{ steps.extract.outputs.messages }}"

          for i in "${!cards[@]}"; do
            CARD="${cards[$i]}"
            MSG="${msgs[$i]}"

            echo "Updating Trello card $CARD with message:"
            echo "$MSG"

            # 1. Add commit message as comment
            curl -X POST \
              "https://api.trello.com/1/cards/$CARD/actions/comments" \
              -d "key=${{ secrets.TRELLO_KEY }}" \
              -d "token=${{ secrets.TRELLO_TOKEN }}" \
              -d "text=$MSG"

            # 2. Move card to Review list
            curl -X PUT \
              "https://api.trello.com/1/cards/$CARD" \
              -d "key=${{ secrets.TRELLO_KEY }}" \
              -d "token=${{ secrets.TRELLO_TOKEN }}" \
              -d "idList=${{ secrets.TRELLO_REVIEW_LIST_ID }}"
          done
